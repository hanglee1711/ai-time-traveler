<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - VI·ªÜT S·ª¨ K√ù</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/chatbot.css">
</head>
<body>
    <!-- HEADER & NAVIGATION -->
    <header class="header">
        <nav class="navbar">
            <a href="/" class="logo">
                <span class="logo-icon">‚è≥</span>
                <span>VI·ªÜT S·ª¨ K√ù</span>
            </a>
            <ul class="nav-menu">
                <li><a href="/" class="nav-link">Trang ch·ªß</a></li>
                <li><a href="chatbot.html" class="nav-link active">Chatbot</a></li>
                <li><a href="timeline.html" class="nav-link">D√≤ng th·ªùi gian</a></li>
                <li><a href="map.html" class="nav-link">B·∫£n ƒë·ªì</a></li>
                <li><a href="game.html" class="nav-link">Tr√≤ ch∆°i</a></li>
                <li><a href="journey.html" class="nav-link">H√†nh tr√¨nh c·ªßa t√¥i</a></li>
                <li class="auth-login-btn"><a href="login.html" class="nav-link btn-gold" style="padding: 0.5rem 1.5rem;">ƒêƒÉng nh·∫≠p</a></li>
                <li class="auth-register-btn"><a href="register.html" class="nav-link" style="padding: 0.5rem 1.5rem;">ƒêƒÉng k√Ω</a></li>
                <li class="auth-user-info" style="display: none;">
                    <span class="nav-link" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem;">
                        <span class="auth-user-avatar">üë§</span>
                        <span class="auth-user-name">User</span>
                    </span>
                </li>
                <li class="auth-logout-btn" style="display: none;"><a href="#" class="nav-link btn-gold" style="padding: 0.5rem 1.5rem;">ƒêƒÉng xu·∫•t</a></li>
            </ul>
        </nav>
    </header>

    <!-- STATUS BAR -->
    <div class="status-bar-container">
        <div class="status-bar">
            <div class="status-item">
                <span class="status-icon">‚≠ê</span>
                <span id="user-level">Level 1</span>
            </div>
            <div class="status-item">
                <span class="status-icon">üí´</span>
                <span id="user-xp">0 XP</span>
            </div>
            <div class="status-item">
                <span class="status-icon">üèÜ</span>
                <span id="user-badges">0 Huy hi·ªáu</span>
            </div>
        </div>
    </div>

    <!-- MAIN CHAT SECTION -->
    <div class="chat-container">
        <!-- SIDEBAR - Historical Figures -->
        <aside class="figures-sidebar">
            <h3 class="sidebar-title">
                <span>üë•</span>
                Nh√¢n v·∫≠t l·ªãch s·ª≠
            </h3>

            <div class="search-box">
                <input type="text" id="figure-search" placeholder="üîç T√¨m ki·∫øm nh√¢n v·∫≠t..." />
            </div>

            <div class="figures-list" id="figures-list">
                <div class="figure-item-loading">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i nh√¢n v·∫≠t...</p>
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="btn btn-secondary" id="clear-chat-btn" style="width: 100%;">
                    üóëÔ∏è X√≥a cu·ªôc tr√≤ chuy·ªán
                </button>
            </div>
        </aside>

        <!-- MAIN CHAT AREA -->
        <main class="chat-main">
            <!-- Figure Profile -->
            <div class="figure-profile" id="figure-profile">
                <div class="profile-placeholder">
                    <h3>Ch·ªçn m·ªôt nh√¢n v·∫≠t ƒë·ªÉ b·∫Øt ƒë·∫ßu</h3>
                    <p>Ch·ªçn nh√¢n v·∫≠t t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</p>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">
                    <h2>‚ú® Ch√†o m·ª´ng ƒë·∫øn v·ªõi Vi·ªát S·ª≠ K√Ω!</h2>
                    <p>B·∫°n c√≥ th·ªÉ:</p>
                    <ul>
                        <li>üí¨ Tr√≤ chuy·ªán v·ªõi c√°c nh√¢n v·∫≠t l·ªãch s·ª≠ Vi·ªát Nam</li>
                        <li>üìö ƒê·∫∑t c√¢u h·ªèi v·ªÅ cu·ªôc ƒë·ªùi v√† s·ª± nghi·ªáp c·ªßa h·ªç</li>
                        <li>üéØ T√¨m hi·ªÉu v·ªÅ c√°c s·ª± ki·ªán l·ªãch s·ª≠ quan tr·ªçng</li>
                        <li>‚≠ê Nh·∫≠n XP v√† huy hi·ªáu khi ho√†n th√†nh cu·ªôc tr√≤ chuy·ªán</li>
                    </ul>
                    <p><strong>H√£y ch·ªçn m·ªôt nh√¢n v·∫≠t ƒë·ªÉ b·∫Øt ƒë·∫ßu!</strong></p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions" id="quick-actions" style="display: none;">
                <button class="quick-action-btn">H·ªèi v·ªÅ s·ª± ki·ªán n·ªïi b·∫≠t</button>
                <button class="quick-action-btn">Nghe k·ªÉ chuy·ªán ƒë·ªùi</button>
                <button class="quick-action-btn">Tri·∫øt l√Ω s·ªëng</button>
                <button class="quick-action-btn">Chi·∫øn thu·∫≠t qu√¢n s·ª±</button>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea
                        id="chat-input"
                        placeholder="üí¨ Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..."
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="send-btn">
                        <span class="send-icon">‚û§</span>
                    </button>
                </div>
                <div class="input-hint">
                    <span>üí° M·∫πo: Nh·∫•n Enter ƒë·ªÉ g·ª≠i, Shift+Enter ƒë·ªÉ xu·ªëng d√≤ng</span>
                </div>
            </div>
        </main>
    </div>

    <!-- SIMPLIFIED INLINE JAVASCRIPT -->
    <script>
        // ==================== CONFIG ====================
        const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:5000/api'
            : window.location.origin + '/api';

        // ==================== STATE ====================
        let currentFigure = null;
        let figures = [];

        // ==================== DOM ELEMENTS ====================
        let figuresList, figureProfile, chatMessages, chatInput, sendBtn, quickActions, clearChatBtn, figureSearch;

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Chatbot initialized');

            // Get DOM elements
            figuresList = document.getElementById('figures-list');
            figureProfile = document.getElementById('figure-profile');
            chatMessages = document.getElementById('chat-messages');
            chatInput = document.getElementById('chat-input');
            sendBtn = document.getElementById('send-btn');
            quickActions = document.getElementById('quick-actions');
            clearChatBtn = document.getElementById('clear-chat-btn');
            figureSearch = document.getElementById('figure-search');

            initEventListeners();
            loadFigures();
        });

        // ==================== LOAD FIGURES ====================
        async function loadFigures() {
            console.log('üì° Loading figures...');

            try {
                const response = await fetch(`${API_BASE_URL}/figures`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                figures = data.figures || [];
                console.log(`‚úÖ Loaded ${figures.length} figures`);

                displayFigures(figures);
            } catch (error) {
                console.error('‚ùå Error:', error);
                figuresList.innerHTML = `<div style="padding: 1rem; text-align: center; color: #ff6b6b;">
                    ‚ùå Kh√¥ng th·ªÉ t·∫£i nh√¢n v·∫≠t<br>
                    <button onclick="location.reload()" style="margin-top: 10px; padding: 10px; background: #FFD700; border: none; border-radius: 5px; cursor: pointer;">Th·ª≠ l·∫°i</button>
                </div>`;
            }
        }

        // ==================== DISPLAY FIGURES ====================
        function displayFigures(figuresToDisplay) {
            if (!figuresList) return;

            figuresList.innerHTML = '';

            figuresToDisplay.forEach((figure, index) => {
                const figureItem = document.createElement('div');
                figureItem.className = 'figure-item';

                figureItem.innerHTML = `
                    <div class="figure-avatar-small">${figure.icon || 'üë§'}</div>
                    <div class="figure-info">
                        <div class="figure-name">${figure.name}</div>
                        <div class="figure-period">${figure.period}</div>
                    </div>
                `;

                figureItem.addEventListener('click', () => selectFigure(figure));
                figuresList.appendChild(figureItem);
            });
        }

        // ==================== SELECT FIGURE ====================
        function selectFigure(figure) {
            console.log('üë§ Selected:', figure.name);
            currentFigure = figure;

            // Update active state
            document.querySelectorAll('.figure-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Show profile
            figureProfile.innerHTML = `
                <div class="figure-profile-active">
                    <div class="figure-avatar-large">${figure.icon || 'üë§'}</div>
                    <div class="figure-details">
                        <h2>${figure.name}</h2>
                        <p>${figure.period}</p>
                        ${figure.description ? `<p class="figure-description">${figure.description}</p>` : ''}
                    </div>
                </div>
            `;

            // Clear chat
            chatMessages.innerHTML = '';

            // Show quick actions
            quickActions.style.display = 'flex';

            // Send greeting
            sendGreeting();
        }

        // ==================== SEND GREETING ====================
        async function sendGreeting() {
            const message = `Xin ch√†o ${currentFigure.name}!`;

            addMessage('user', message);
            showTyping();

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, figure: currentFigure.name })
                });

                const data = await response.json();
                hideTyping();
                addMessage('assistant', data.message);
            } catch (error) {
                console.error('Chat error:', error);
                hideTyping();
                addMessage('assistant', `Xin ch√†o! Ta l√† ${currentFigure.name}. H√£y h·ªèi ta ƒëi·ªÅu g√¨!`);
            }
        }

        // ==================== SEND MESSAGE ====================
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // N·∫øu ch∆∞a ch·ªçn nh√¢n v·∫≠t, t·ª± ƒë·ªông ph√°t hi·ªán t·ª´ tin nh·∫Øn
            let figureName = currentFigure ? currentFigure.name : null;

            if (!figureName) {
                // T√¨m t√™n nh√¢n v·∫≠t trong tin nh·∫Øn
                const messageLower = message.toLowerCase();
                const foundFigure = figures.find(fig =>
                    messageLower.includes(fig.name.toLowerCase()) ||
                    (fig.alt_names && fig.alt_names.some(alt => messageLower.includes(alt.toLowerCase())))
                );

                if (foundFigure) {
                    // T·ª± ƒë·ªông ch·ªçn nh√¢n v·∫≠t v√† hi·ªÉn th·ªã
                    selectFigure(foundFigure);
                    figureName = foundFigure.name;
                } else {
                    // Kh√¥ng t√¨m th·∫•y nh√¢n v·∫≠t, g·ª≠i tin nh·∫Øn chung (backend s·∫Ω t·ª± ph√°t hi·ªán)
                    figureName = null;
                }
            }

            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;

            addMessage('user', message);
            showTyping();

            try {
                const body = { message };
                if (figureName) {
                    body.figure = figureName;
                }

                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                hideTyping();

                // N·∫øu backend tr·∫£ v·ªÅ figure m·ªõi, t·ª± ƒë·ªông ch·ªçn
                if (data.figure && !currentFigure) {
                    const detectedFigure = figures.find(f => f.name === data.figure);
                    if (detectedFigure) {
                        selectFigure(detectedFigure);
                    }
                }

                addMessage('assistant', data.message);
            } catch (error) {
                console.error('Chat error:', error);
                hideTyping();
                addMessage('assistant', 'Xin l·ªói, c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ==================== ADD MESSAGE ====================
        function addMessage(role, content) {
            const welcome = chatMessages.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const time = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `
                <div class="message-avatar">${role === 'user' ? 'üë§' : (currentFigure?.icon || 'ü§ñ')}</div>
                <div class="message-content">
                    <div class="message-bubble">${content}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ==================== TYPING INDICATOR ====================
        let typingDiv = null;

        function showTyping() {
            typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `
                <div class="message-avatar">${currentFigure?.icon || 'ü§ñ'}</div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            if (typingDiv) {
                typingDiv.remove();
                typingDiv = null;
            }
        }

        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            sendBtn.addEventListener('click', sendMessage);

            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });

            clearChatBtn.addEventListener('click', () => {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a cu·ªôc tr√≤ chuy·ªán?')) {
                    chatMessages.innerHTML = '<div class="welcome-message"><h2>‚ú® Ch·ªçn nh√¢n v·∫≠t ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i</h2></div>';
                    currentFigure = null;
                    quickActions.style.display = 'none';
                    document.querySelectorAll('.figure-item').forEach(item => item.classList.remove('active'));
                }
            });

            if (figureSearch) {
                figureSearch.addEventListener('input', () => {
                    const term = figureSearch.value.toLowerCase();
                    const filtered = term ? figures.filter(f =>
                        f.name.toLowerCase().includes(term) ||
                        f.period.toLowerCase().includes(term)
                    ) : figures;
                    displayFigures(filtered);
                });
            }

            // Quick actions
            quickActions.addEventListener('click', (e) => {
                if (e.target.classList.contains('quick-action-btn')) {
                    chatInput.value = e.target.textContent;
                    chatInput.focus();
                }
            });
        }

        console.log('‚úÖ Chatbot ready!');
    </script>

    <!-- Load enhancements for better UX -->
    <script src="js/chatbot-enhancements.js"></script>

    <!-- Load auth for user status -->
    <script src="js/auth.js"></script>
    <!-- Background Music Controller -->
    <script src="js/background-music.js"></script>
</body>
</html>
